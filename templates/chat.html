<!-- [FILE: chat.html] -->
<!-- [VERSION: 1.0.0.69.3] -->
<!-- [DATE: 2025-08-12] -->
<!-- [PROJECT: HKKM - Yuzu Companion] -->
<!-- [DESCRIPTION: Chat interface for AI companion system] -->
<!-- [AUTHOR: Project Lead: Bani Baskara] -->
<!-- [TEAM: Deepseek, GPT, Qwen, Aihara] -->
<!-- [REPOSITORY: https://guthib.com/icedeyes12] -->
<!-- [LICENSE: MIT] -->

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat | Yuzu Companion</title>
    
    <!-- CSS Imports -->
    <!-- Tailwind CSS (Primary: CDN, Fallback: Local) -->
    <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.local.css') }}" media="print" onload="this.media='all'; this.onload=null;">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.local.css') }}"></noscript>
    
    <!-- Theme and Custom Styles (Preserved) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/multimodal.css') }}">
    
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body>
    <!-- Unified Sidebar -->
    <div class="sidebar" id="mainSidebar">
      <div class="sidebar-header">
        <h2>Yuzu Companion</h2>
        <button class="close-sidebar" onclick="toggleSidebar()">×</button>
      </div>
      
      <div class="sidebar-content">
        <!-- Navigation -->
        <div class="sidebar-section">
          <h3>Navigation</h3>
          <a href="/" class="sidebar-link" onclick="toggleSidebar()">
            <span class="sidebar-icon home-icon"></span> Home
          </a>
          <a href="/chat" class="sidebar-link active" onclick="toggleSidebar()">
            <span class="sidebar-icon chat-icon"></span> Chat
          </a>
          <a href="/config" class="sidebar-link" onclick="toggleSidebar()">
            <span class="sidebar-icon config-icon"></span> Config
          </a>
          <a href="/about" class="sidebar-link" onclick="toggleSidebar()">
            <span class="sidebar-icon about-icon"></span> About
          </a>
        </div>
        
        <!-- Theme Selector -->
        <div class="sidebar-section">
          <h3>Theme</h3>
          <div class="custom-dropdown" id="themeDropdown">
            <div class="dropdown-selected">
              <span class="selected-text">Dark Blue</span>
              <span class="dropdown-arrow">▼</span>
            </div>
            <div class="dropdown-options">
              <div class="dropdown-option" data-value="dark">
                <span class="theme-preview dark-preview"></span>
                Dark Blue
              </div>
              <div class="dropdown-option" data-value="light">
                <span class="theme-preview light-preview"></span>
                Soft Light
              </div>
              <div class="dropdown-option" data-value="lavender">
                <span class="theme-preview lavender-preview"></span>
                Pastel Lavender
              </div>
              <div class="dropdown-option" data-value="mint">
                <span class="theme-preview mint-preview"></span>
                Pastel Mint
              </div>
              <div class="dropdown-option" data-value="peach">
                <span class="theme-preview peach-preview"></span>
                Pastel Peach
              </div>
              <div class="dropdown-option" data-value="dark-lavender">
                <span class="theme-preview dark-lavender-preview"></span>
                Dark Lavender
              </div>
              <div class="dropdown-option" data-value="vanilla-orange">
                <span class="theme-preview vanilla-orange-preview"></span>
                Vanilla Orange
              </div>
            </div>
          </div>
        </div>
        
        <!-- Session Management -->
        <div class="sidebar-section" id="sessionSection">
          <h3>Sessions</h3>
          <button class="sidebar-btn" onclick="createNewSession()">
            <span class="sidebar-icon add-icon"></span> New Chat
          </button>
          <div class="sessions-list" id="sidebarSessionsList">
            <div class="loading">Loading sessions...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hamburger Menu -->
    <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- MAIN WRAPPER -->
    <div class="chat-app flex flex-col min-h-screen">
        <header class="chat-header flex items-center justify-between p-4">
            <div class="header-left flex flex-col">
                <h1 class="partner-name">{{ profile.partner_name }}</h1>
                <div class="session-name" id="sessionName"></div>
            </div>
            <div class="affection-display flex items-center gap-2">
                <span class="affection-icon"></span>
                <div class="affection-bar">
                    <div class="affection-fill" style="width: {{ profile.affection }}%;"></div>
                </div>
            </div>
        </header>

        <main class="chat-container flex-1 overflow-auto" id="chatContainer">
            <!-- messages will appear here -->
        </main>

        <!-- TYPING INDICATOR -->
        <div id="typingIndicator" class="typing-indicator hidden flex gap-2 p-2">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- SCROLL TO BOTTOM BUTTON -->
        <button id="scrollToBottomBtn" class="scroll-to-bottom-btn hidden fixed rounded-full shadow-lg transition" onclick="scrollToBottom()">
            <span class="scroll-icon">↓</span>
        </button>

        <!-- CLEAN INPUT AREA - WITH MULTIMODAL SUPPORT -->
        <div class="input-area flex gap-2 p-4">
            <!-- Multimodal toggle button will be inserted here by JavaScript -->
            <textarea id="messageInput" placeholder="Type your message ..." rows="1" class="flex-1 rounded"></textarea>
            <button id="sendButton" class="rounded px-4 py-2">Send</button>
        </div>
    </div>
    
    <!-- Script loading order: sidebar → marked → highlight → renderer → chat -->
    
    <!-- 1. Sidebar -->
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    
    <!-- 2. marked.js (CDN with fallback) -->
    <!-- TODO: Add integrity hash when available from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" 
            crossorigin="anonymous"
            onerror="this.onerror=null; this.src='{{ url_for('static', filename='js/lib/marked.min.js') }}'"></script>
    
    <!-- 3. highlight.js (CDN with fallback) -->
    <!-- TODO: Add integrity hash when available from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
            crossorigin="anonymous"
            onerror="this.onerror=null; this.src='{{ url_for('static', filename='js/lib/highlight.min.js') }}'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js" crossorigin="anonymous"></script>
    
    <!-- 4. Renderer (marked.js + highlight.js integration) -->
    <script src="{{ url_for('static', filename='js/renderer.js') }}"></script>
    
    <!-- 5. Chat (main application logic) -->
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>
</html>