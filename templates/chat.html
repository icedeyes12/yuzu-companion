<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat | Yuzu Companion</title>
    
    <!-- Tailwind CSS via script (works even when CDN blocked) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Theme CSS (existing themes) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/multimodal.css') }}">
    
    <!-- Highlight.js for syntax highlighting -->
    <link 
        rel="stylesheet" 
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
        integrity="sha512-rO+olRTkcf304DQBxSWxln8JXCzTHlKnIdnMUwYvQa9/Jd4cQaNkItIUj6Z4nvW1dqK0SKXLbn9h4KwZTNtAyw=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer">
    
    <style>
        /* Tailwind Fallback - Essential utilities in case CDN fails */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1 1 0%; }
        .flex-shrink-0 { flex-shrink: 0; }
        .items-center { align-items: center; }
        .items-end { align-items: flex-end; }
        .justify-start { justify-content: flex-start; }
        .justify-end { justify-content: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .h-screen { height: 100vh; }
        .h-full { height: 100%; }
        .h-12, .h-\[48px\] { height: 48px; }
        .min-h-\[48px\] { min-height: 48px; }
        .max-h-\[200px\] { max-height: 200px; }
        .w-full { width: 100%; }
        .max-w-full { max-width: 100%; }
        .p-4 { padding: 1rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .space-y-4 > * + * { margin-top: 1rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .opacity-60 { opacity: 0.6; }
        .opacity-75 { opacity: 0.75; }
        .hidden { display: none; }
        
    </style>
    <style>
        /* Custom styles to integrate with existing themes */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Chat container adjustments with improved contrast */
        .chat-wrapper {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }
        
        /* Chat container background - slightly different from body */
        #chatContainer {
            background-color: rgba(0, 0, 0, 0.12);
        }
        
        @media (min-width: 768px) {
            .sidebar-open .chat-wrapper {
                margin-left: 280px;
            }
        }
        
        /* Message bubbles */
        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* User messages - keep bubble style */
        .message-bubble.user {
            background-color: var(--message-user-bg);
            color: var(--text-color);
            border-left: 3px solid var(--border-user);
        }
        
        /* AI messages - full width, completely flat (no bubble) */
        .message-bubble.ai {
            max-width: 100%;
            background-color: transparent;
            color: var(--text-color);
            border-left: none;
            padding: 0;
            position: relative;
        }
        
        /* AI message content - no background, completely flat */
        .message-bubble.ai .markdown-content {
            background-color: transparent;
            padding: 0;
        }
        
        /* Copy entire message button */
        .copy-message-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .message-bubble.ai:hover .copy-message-btn {
            opacity: 0.7;
        }
        
        .copy-message-btn:hover {
            opacity: 1 !important;
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .copy-message-btn.copied {
            background-color: var(--accent-color);
        }
        
        /* Markdown content styles */
        .markdown-content {
            line-height: 1.6;
        }
        
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
            display: block;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Ensure images inside links or other elements also render */
        .markdown-content a img {
            display: inline-block;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            overflow-x: auto;
            display: block;
        }
        
        .markdown-content th,
        .markdown-content td {
            border: 1px solid var(--border-lavender, rgba(168, 200, 255, 0.3));
            padding: 8px 12px;
            text-align: left;
        }
        
        .markdown-content th {
            background-color: var(--code-bg);
            font-weight: 600;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid var(--accent-lavender, #a8c8ff);
            padding-left: 16px;
            margin: 12px 0;
            opacity: 0.9;
            /* Add subtle background for nested hierarchy */
            background-color: rgba(0, 0, 0, 0.08);
            padding: 12px 16px;
            border-radius: 6px;
        }
        
        .markdown-content code {
            background-color: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }
        
        .markdown-content pre {
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            /* Add subtle shadow for separation */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            /* Ensure code blocks are visually distinct */
            filter: brightness(0.95);
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }
        
        .markdown-content li {
            margin: 4px 0;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin: 16px 0 8px 0;
            font-weight: 600;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 1px solid var(--border-lavender);
            margin: 16px 0;
        }
        
        /* Code block with copy button */
        .code-block {
            position: relative;
            margin: 12px 0;
            border-radius: 8px;
            /* Add subtle shadow for separation from parent */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .code-block pre {
            margin: 0;
            /* Remove duplicate shadow since parent has it */
            box-shadow: none;
        }
        
        .code-block .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--copy-button-bg);
            color: var(--text-color);
            border: 1px solid var(--code-border);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .code-block .copy-btn:hover {
            background-color: var(--copy-button-hover);
        }
        
        .code-block .copy-btn.copied {
            background-color: var(--accent-color);
        }
        
        /* Affection bar */
        .affection-bar {
            width: 120px;
            height: 8px;
            background-color: var(--code-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .affection-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-lavender));
            transition: width 0.3s ease;
        }
        
        /* Scroll to bottom button - dynamic positioning */
        .scroll-to-bottom {
            position: fixed;
            bottom: calc(80px + var(--input-height, 0px));
            right: 24px;
            background-color: var(--button-bg);
            color: var(--button-text);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: bottom 0.2s, opacity 0.3s, transform 0.3s;
            z-index: 40;
        }
        
        .scroll-to-bottom:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        
        .scroll-to-bottom.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: var(--accent-color);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        /* Input area */
        .input-container {
            background-color: var(--input-bg);
            border-top: 1px solid var(--border-lavender);
        }
        
        .input-area textarea {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-lavender);
            resize: none;
            transition: border-color 0.2s;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .input-area button {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: background-color 0.2s;
        }
        
        .input-area button:hover:not(:disabled) {
            background-color: var(--button-hover);
        }
        
        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Header styles */
        .chat-header {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-lavender);
        }
        
        /* Hamburger menu inside header - very subtle utility control */
        .hamburger-menu-inline {
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: all 0.3s;
            opacity: 0.5;
            flex-shrink: 0;
        }
        
        .hamburger-menu-inline span {
            width: 18px;
            height: 2px;
            background-color: var(--text-color);
            border-radius: 1px;
            transition: all 0.3s;
            opacity: 0.6;
        }
        
        .hamburger-menu-inline:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Old fixed hamburger menu - hide it */
        .hamburger-menu {
            display: none;
        }
        
        /* Details/summary support with nested hierarchy */
        .markdown-content details {
            margin: 12px 0;
            border: 1px solid var(--border-lavender);
            border-radius: 8px;
            padding: 12px;
            /* Add subtle background for nested hierarchy */
            background-color: rgba(0, 0, 0, 0.08);
        }
        
        .markdown-content summary {
            cursor: pointer;
            font-weight: 600;
            user-select: none;
        }
        
        .markdown-content summary:hover {
            color: var(--accent-color);
        }
    </style>
</head>
<body>
    <!-- Sidebar (existing implementation) -->
    <div class="sidebar" id="mainSidebar">
      <div class="sidebar-header">
        <h2>Yuzu Companion</h2>
        <button class="close-sidebar" onclick="toggleSidebar()">×</button>
      </div>
      
      <div class="sidebar-content">
        <!-- Navigation -->
        <div class="sidebar-section">
          <h3>Navigation</h3>
          <a href="/" class="sidebar-link" onclick="toggleSidebar()">
            <span class="sidebar-icon home-icon"></span> Home
          </a>
          <a href="/chat" class="sidebar-link active" onclick="toggleSidebar()">
            <span class="sidebar-icon chat-icon"></span> Chat
          </a>
          <a href="/config" class="sidebar-link" onclick="toggleSidebar()">
            <span class="sidebar-icon config-icon"></span> Config
          </a>
          <a href="/about" class="sidebar-link" onclick="toggleSidebar()">
            <span class="sidebar-icon about-icon"></span> About
          </a>
        </div>
        
        <!-- Theme Selector -->
        <div class="sidebar-section">
          <h3>Theme</h3>
          <div class="custom-dropdown" id="themeDropdown">
            <div class="dropdown-selected">
              <span class="selected-text">Dark Blue</span>
              <span class="dropdown-arrow">▼</span>
            </div>
            <div class="dropdown-options">
              <div class="dropdown-option" data-value="dark">
                <span class="theme-preview dark-preview"></span>
                Dark Blue
              </div>
              <div class="dropdown-option" data-value="light">
                <span class="theme-preview light-preview"></span>
                Soft Light
              </div>
              <div class="dropdown-option" data-value="lavender">
                <span class="theme-preview lavender-preview"></span>
                Pastel Lavender
              </div>
              <div class="dropdown-option" data-value="mint">
                <span class="theme-preview mint-preview"></span>
                Pastel Mint
              </div>
              <div class="dropdown-option" data-value="peach">
                <span class="theme-preview peach-preview"></span>
                Pastel Peach
              </div>
              <div class="dropdown-option" data-value="dark-lavender">
                <span class="theme-preview dark-lavender-preview"></span>
                Dark Lavender
              </div>
              <div class="dropdown-option" data-value="vanilla-orange">
                <span class="theme-preview vanilla-orange-preview"></span>
                Vanilla Orange
              </div>
            </div>
          </div>
        </div>
        
        <!-- Session Management -->
        <div class="sidebar-section" id="sessionSection">
          <h3>Sessions</h3>
          <button class="sidebar-btn" onclick="createNewSession()">
            <span class="sidebar-icon add-icon"></span> New Chat
          </button>
          <div class="sessions-list" id="sidebarSessionsList">
            <div class="loading">Loading sessions...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Chat Wrapper -->
    <div class="chat-wrapper flex flex-col h-screen">
        <!-- Header -->
        <header class="chat-header px-6 py-2 flex items-center justify-between flex-shrink-0">
            <!-- Hamburger Menu inside header -->
            <button class="hamburger-menu-inline" id="hamburgerMenu" onclick="toggleSidebar()">
              <span></span>
              <span></span>
              <span></span>
            </button>
            
            <div class="flex flex-col flex-1 ml-4 gap-0.5">
                <h1 class="text-lg font-semibold leading-tight">{{ profile.partner_name }}</h1>
                <div class="text-xs opacity-75 leading-tight" id="sessionName">Loading session...</div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs">Affection</span>
                <div class="affection-bar">
                    <div class="affection-fill" style="width: {{ profile.affection }}%;"></div>
                </div>
                <span class="text-xs font-medium">{{ profile.affection }}%</span>
            </div>
        </header>

        <!-- Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Chat Messages Container -->
        <main id="chatContainer" class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
            <!-- Messages will be dynamically added here -->
        </main>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator hidden px-6">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- Scroll to Bottom Button -->
        <button class="scroll-to-bottom hidden" id="scrollToBottom" onclick="scrollToBottom()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
        </button>

        <!-- Input Area -->
        <div class="input-area px-6 py-4 flex-shrink-0">
            <div class="flex gap-3 items-end">
                <textarea 
                    id="messageInput" 
                    placeholder="Type your message... (Enter for newline, Ctrl+Enter to send)"
                    rows="1"
                    class="flex-1 px-4 py-3 rounded-lg min-h-[48px] max-h-[200px]"
                ></textarea>
                <button 
                    id="sendButton"
                    class="px-6 py-3 rounded-lg font-medium h-[48px] flex-shrink-0"
                >
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
        integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"
        integrity="sha512-SYfDUYPg5xspsG6OOpXU366G8SZsdHOhqk/icdrYJ2E/WKZxPxze7d2HD3AyXpT7U22PZ5y74xRpqZ6A2bJ+kQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    
    <!-- Sidebar script (existing) -->
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    
    <!-- Fallback markdown parser -->
    <script src="{{ url_for('static', filename='js/markdown.js') }}"></script>
    
    <!-- Unified Chat Script (single controller) -->
    <script src="{{ url_for('static', filename='js/chat-unified.js') }}"></script>
</body>
</html>
